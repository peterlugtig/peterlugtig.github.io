---
title: "ratio estmation"
author: "Peter Lugtig"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

For the next exercise, you will need the following libraries:

```{r setup, message=F}
require(sampling)
require(survey)
require(dplyr)
require(ggplot2)
```

## Introduction

In this short exercise, you will prctice with specifying a ratio estimator in R, 
and hopefully will learn more about why ratio estimators are so useful in specific circumstances.

We will use a new dataset for this exercise that centers on my favourite drink in the world: coffee.
Imagine a situation where Utrecht University would like to keep track of how many coffees are being drunk on the buildings on campus in a month.
Perhaps they want to know how much coffee is being taken from the coffee machines, perhaps they simply need to know how many coffees are being drunk to prepare a new coffee contract with a supplier. We will first concentrate on estimating the mean number of coffees per machine, but can also estimate the total directly.

There are 1000 machines on campus, some of them used more often than others, but lets imagine the university is not willing to use any information on for example the type of building to inform a potentially stratified design. 
Instead, they opt to equip a SRS of 100 machines with a device that counts the number of coffees drunk.

Let's sample some data. First the population data (pretend for now you don't know about these data, like in real life.)

```{r population dataset, results='hide'}
set.seed(11)
coffees <- round(rpois(1000,350)+rnorm(100,0,sd=150))
coffees[coffees<0] <- 0
# and energy use
energy <- 0.072*coffees+rnorm(n=1000,mean=0,sd=1)
energy[energy<0] <- 0
coffeedata <- as.data.frame(cbind(coffees,energy))
names(coffeedata) <- c("n","energy")
```

And sample an SRs of size=100 from the just-created population:

```{r sample of 100 coffee machines, results='hide'}
set.seed(11)
coffeedata$srs <- srswor(100,nrow(coffeedata))
coffee <- subset(coffeedata, srs==1)
```

We specify the survey design object for the SRS sample

```{r srs design}
coffee$fpc <- 1000
srsdesign <-svydesign(ids=~1,fpc=~fpc,data=coffee)
```

and estimate the mean number of coffees using normal SRS estimation (as covered before), including the se.
```{r svytotal, results='hide'}
svymean(~n, design=srsdesign) # se =15.415)
# or estimate the confidence interval directly
confint(svymean(~n, design=srsdesign)) #[312.237;372.663]
```

As the width of the confidence interval is more than 60 cups of coffee, the university hires a survey researcher to design a more efficient sample and estimate the total number of coffees drunk more efficiently.  
The researcher finds out that the although the university does not keep track of the number of coffees made per machine, it does track the energy consumption per machine. Can this information be used? The dataset (including info from the SRS sample) looks as follows. 

```{r design ratio estimator}
# With the ratio0-estimator we will predict for every case in our population, 
# based on a covariate x (energy) what the value of the dependent variable y (n) is.
# I am creating a new predicted population for this, 
# where I delete the values for all cases that I did not sample.
predictedpop <-coffeedata
predictedpop$n[predictedpop$srs!=1] <- NA
```

# Question 1:
Now what? Can we do better? Perhaps! But we have to model the relation between energy use and the number of coffees.
Lets make a plot (using just the survey data), and decide whether we can use a ratio estimator.
Do you think a ratio estimator is here a good idea judging the plot?

``` {r plot coffees, message=F}
ggplot(coffee,aes(y=n, x=energy))+
         geom_point()+
         geom_smooth()
```

```{r anwer, include=F}
#answer: looks great!
```
 
# Queston 2: 
Run the code below to first estimate the ratio between coffees/energy, and then use that ratio to predict the mean number of coffees. What happens to the precision when we use a ratio estimator? We here need two steps:  
1. We estimate the ratio of energy/n

```{r ratio estimator, results='hide', message=F}
# estimate the ratio betwen energy/n
ratio <- svyratio(~n,~energy, design=srsdesign)
# what is this ratio?
print(ratio) # with 1 KwH of energy, 13.81 coffees are made on average
```
We can now use the ratio, to predict for everuy value of energy we have in our population, the predicted value on n (coffees)
 
```{r answer to question 2, results='hide'}
# We here now use the predict value, which takes the output of a regression model (below:"ratio")
# and then we multiply these coefficients with the values of our covariate (energy) 
# to estimate the mean on y (n coffees)
# the "total" command is used in the predict() function to predict a new variable
predict(ratio, total=mean(predictedpop$energy))
# we can also manually get to this mean by taking the ratio * mean(x)
ratio[[1]] * mean(coffeedata$energy)

```


```{r answer se in ratip}
# answer: and the standard error = only 1.35, see below, compared to # se =15.4 with an SRS!
```

## Question 3:

In our dataset, the standard error becomes much smaller because of ratio estimation. Why then not always use a ratio-estimator?
First, we need to have a dependent variable that is of ratio measurement level. The ratio estimator will not work when we for example try to estimate weight or height in the "boys" dataset, as boys never have a height or weight of zero.
Secondly, we need to have a covariate on our sampling frame (like "energy use") that is ideally a perfectly linear predictor of our dependent variable. The relationship between height and weight is not perfectly linear. The relationship between energy use and the number of coffees from a machine is however. Or is it not?

Investigate whether the ratio estimator you used in question is actually unbiased by comparing the mean to the population mean in the "coffeedata". What is the prediction of the total number of coffees drunk, and how much bias is there in this estimate?

```{r ratio MSE estimation, include = F}
# what about bias in SRS?
mean(coffee$n)-mean(coffeedata$n) # -.91
# MSE srs:
-.916^2 + 15.415 # no bias, but large variance (se)


# bias in ratio-esttimator
bias <- predict(ratio, total=mean(predictedpop$energy))[[1]] -mean(coffeedata$n) 
print(bias) # bias in the ratio estimator = -2. So there is some bias in the ratio estimator

#and the  MSE for the  ratio estimator:
bias^2 + predict(ratio, total=mean(predictedpop$energy))[[2]]

# MSE is largely caused by bias in the ratio estimator, but still smaller than with an SRS
```

## Question 4:

Can you think of a reason why there is some bias in the ratio estimator for the total number of coffees drunk at the UU?
Think about an answer first, and then run the code below. What do you find? 

```{r bias in ratio estimator, results='hide'}
 # why?
summary(glm(n~energy, data=coffee))
```

```{r answer bias in ratio estimator, include=F}
# there is bias in the ratio estimator because the intercept is not 0!
# you could have spotted this if you had zoomed in on the intercept in the scatterplot
 ggplot(coffee,aes(y=n, x=energy))+
         geom_point()+
         geom_smooth()
# the regression line should cross the origin at (0,0), but it does not
# even when a machine does not produce coffee, there is still some energy being used, 
# likely for being on standby
```

A possible solution to the fact that the ratio estimator can in some cases be biased, is to extend the model with more covariates. 
In such a case, we move from using a "model-assisted"  estimator like ratio estimation to a truly "model-based"  estimator. In order to understand how model-based estimators work, look at the exercise "Regression estimation"

## Question 5 (if time left):

The ratio estimator is in practice used quite often in cluster samples. Can you think of why?  
Rather than estimating a mean, an outcome is often the total, which can be estimated with the svytotal() command. Can you estimate the total number of coffees produced, rather than the mean
(see .Rmd file for answers)

```{r answer ratio in cluster samples, include=F}
# We typically know the size of a cluster, both in terms of the # of people, and size of landmass
# At the same time: the size of a cluster is often related to all kinds of things you can count. Eg.:

# when you think of population size:
# demographic events, like the total # of newborns, marriages, deaths
# other events, like hospitalizations, crime, houses sold, etc.

# when uou think of area size
# counts of plants, animals
# agricultural production.


# we can also estimate the total for the number of coffees drunk; this is simply the mean (and standard error) * 100
svytotal(~n, design=srsdesign) # se =15415
# or the confidence interval
confint(svytotal(~n, design=srsdesign)) #[312237;372663]
```



 -- end of document --