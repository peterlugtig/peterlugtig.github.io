---
title: "ratio estmation"
author: "Peter Lugtig"
date: "10/10/2020"
output: pdf_document
---

```{r setup, include=FALSE}
require(sampling)
require(survey)
```

## Introduction

We are using (again) the same example dataset. Load it if necessary
```{r data, results='hide'}
id <- c(1:20)
income <- c(1800,2000,2200,2500,3000,3600,3700,3900,6100,7200,1900,1900,2400,
            2300,3300,3300,3300,4300,5900,7400) #euros per month
education <-c(1,2,1,2,2,3,1,3,2,3,1,2,1,2,2,3,1,3,2,3) #lo, middle,hi
country <- c("A","B","C","D","A","B","A","B","C","D","A","B","C","D","D","C","A","B","C","D")
gender <- c("f","f","m","m","f","m","m","m","f","f","f","f","m","m","f","m","m","m","f","f")

data <- as.data.frame(cbind(id,income,education,country,gender))
data$fpc <- 20
# some details
data$income <- as.numeric(as.character(data$income))
mean(data$income) # 3600 euros
var(data$income) # 3054737
```

we will first fit the one stage cluster sample that we also used in the class exercise of week 40

```{r one-stage cluster sample, results='hide'}
# clustering, sample 2 clusters (1 stage cluster sample) 
set.seed(111)
srswor(2,4) # cluster D
cluster1 <- subset(data,country=="D" |country=="C")
cluster1$fpc3 <- 4 # 4 countries
# specificy
clusterdesign1 <- svydesign(id=~country,fpc=~fpc3, data=cluster1)
svymean(~income,design=clusterdesign1,deff=T)
```

# Question 1:
One useful thing to check in R - especially if you are starting towork with multistage samples is to simply
request the survey design object. Run the code below and check whether you indeed did a one-stage cluster sample

```{survey design object}
clusterdesign1
```

# Question 2:
One-stage cluster samples are sometimes used when clusters are small. For example, when you interview all members
of a household. When you are sampling towns, schools, or hospitals, we usually resort to two-stage cluster sampling, or even multi-stage cluster sampling 
(e.g. schools - classes - kids). One big advantage that sampling within clusters gives you much better control over the sample sizes within clusters.
Specifying a two-stage cluster sample is a bit more tricky, as we know have two ~id variables, and two ~fpc variables. 
Run the example below, but change the seed so that you are (likely) drawing different clusters. Adapt the code accordingly.
Why do we know get a good estimate of the design effect? Also, what does this design effect mean?

``` {two stage cluster sample, results='hide'}
# two-stage cluster sample
# clustering, sample 2 clusters (1 stage cluster sample) (actually is a bit too large)
set.seed(111)
srswor(2,4) # cluster C&D
# now sample within every cluster
# what are the sizes of each cluster again?
table(data$country) # 5 in each country
set.seed(11)
data$cluster2[data$country=="B"] <- srswor(3,nrow(data[data$country=="B",]))
set.seed(11)
data$cluster2[data$country=="D"] <- srswor(3,nrow(data[data$country=="D",]))
cluster2 <- subset(data,cluster2==1)
# specificy
cluster2$fpc3 <- 4 # 4 countries
cluster2$fpc4 <-nrow(data[data$country=="B",]) # 5 per country (this can vary!), so here fpc3*fpc4=20

clusterdesign2 <- svydesign(id=~country+id,fpc=~fpc3+fpc4, data=cluster2) 
svymean(~income,design=clusterdesign2,deff=T)
```

````{answer}
#answer: the design effect in my example is 1.39, implying that the cluster design is inefficient, but not very inefficient
# the reason we now get a good estimate of the design effect is that in a one-stage cluster sample, we draw 
```

# Question 3:
In the above above example, we sampled 3 cases from ach country. What about sampling more or fewer cases from each country?
What happens if you sample 4-2 elements from each country, or 5-1? 
a) Try this out
b) Can you explain which specific design gives you the smallest design effect when you look at the variance in income in every country?


# end of file
